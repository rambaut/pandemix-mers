pandemix=(function(){var e={};e.counter=0;e.focusedPanel=0;e.scale=1;e.panels=[];e.extraUpdates={};e.selectedLeaves=[];e.selectedNodes=[];e.selectedDate=new Date(0);e.selectedPeriod=[0,0];e.globalData={};e.map={};d3.selection.prototype.size=function(){var f=0;this.each(function(){f+=1});return f};e.extraUpdates.timeSlideUpdate=function(){d3.select("body").selectAll("span.date-calendar").text(e.selectedDate.toDateString().substring(4))};e.addGlobalZoomButton=function(f){var h=f.zoomAmount||0.5;var g=d3.select(f.target).attr("class","zoomControl");g.append("div").attr("class","zoom increase").on("click",function(){d(1,h)});g.append("div").attr("class","zoom decrease").on("click",function(){d(-1,h)})};e.addPlayPauseButton=function(g){var j=false,l,m=g.updateInterval||200,f=g.updateStep||10,h=d3.select(g.target).attr("class","playPauseButton").on("click",function(){if(j){j=false;clearInterval(l)}else{j=true;l=setInterval(function(){if(e.selectedDate){e.selectedDate.setDate(e.selectedDate.getDate()+f);if(e.selectedDate>e.maxDate){e.selectedDate=new Date(e.maxDate.getTime());clearInterval(l);j=false;h.classed("playing",j)}}else{e.selectedDate=e.minDate}e.callUpdate("timeSlideUpdate",true)},m)}h.classed("playing",j)})};e.addSearchBox=function(f){d3.select(f.target).attr("class","searchBox").append("input").attr("type","text").attr("id","searchInput").attr("value","search").on("keyup",b)};e.addColorPicker=function(f){d3.select(f.target).attr("class","colorBox").append("input").attr("type","text").attr("id","colorInput").attr("value","color").on("keyup",a)};function b(f){var f=f||d3.select("input#searchInput").node().value;var g=new RegExp(f);var h=[];if(f){d3.selectAll("svg.treePanel").selectAll(".leaf").each(function(j){if(g.test(j.name)){h.push(j)}})}e.selectedLeaves=h;e.callUpdate("leafSelectionUpdate")}function a(){var f=d3.select("input#colorInput").node().value;if(f===""){f=null}e.callUpdate("leafColorUpdate",f)}function d(f,h){var g=e.scale+h*f;if(g<1){g=1}e.scale=g;e.callUpdate("zoomUpdate")}e.initializeCrossfilter=function(){e.nodes=crossfilter();e.nodeDateDim=e.nodes.dimension(function(f){return f.date});e.links=crossfilter();e.linkStartDateDim=e.links.dimension(function(f){return f.startDate});e.linkEndDateDim=e.links.dimension(function(f){return f.endDate});e.treeIdDim=e.links.dimension(function(f){return f.treeID});e.taxa=crossfilter();e.nameDim=e.taxa.dimension(function(f){return f.name});e.locDim=e.taxa.dimension(function(f){return f.location});e.dateDim=e.taxa.dimension(function(f){return f.date})};e.getNodeKey=function(g,f){return(g.name||f)};e.getLinkKey=function(g,f){return(g.target.name||f)};e.contains=function(f,h){var g;for(g=0;g<f.length;g+=1){if(f[g]===h){return true}}return false};e.accContains=function(f,h,j,l){var g;for(g=0;g<f.length;g+=1){if(j(f[g])===l(h)){return true}}return false};e.indexOf=function(f,h,j,l){var g;for(g=0;g<f.length;g+=1){if(j(f[g])===l(h)){return g}}return -1};e.containsLeaf=function(f,h){if(f.length===0){return false}var g;for(g=0;g<f.length;g+=1){if(f[g].name===h.name){return true}}return false};e.callUpdate=function(f){var g;for(g=0;g<e.panels.length;g+=1){if(e.panels[g].hasOwnProperty(f)){e.panels[g][f](arguments)}}if(e.extraUpdates.hasOwnProperty(f)){e.extraUpdates[f]}};e.panelsLoaded=function(f){var g=true,h;for(h=0;h<e.panels.length;h+=1){if(e.panels[h].panelType===f&&e.panels[h].hasOwnProperty("finishedLoading")){g=g&&e.panels[h].finishedLoading}}return g};e.when=function(j,h,f){if(j()){h()}else{var f=f||100;setTimeout(function g(){if(j()){h()}else{setTimeout(g,f)}},f)}};e.getHSBColor=function(o,n,h,j,m){if(!(o&&n)&&o!==0){throw new Error("Called for HSB color without specifying color index or total colors.")}var f=h||0;var g=j||50;var p=m||50;var q=o%n;var l=(f+q*360/n)%360;return"hsl("+l+","+g+"%,"+p+"%)"};e.clamp=function(h,g,f){if(h<g){return g}if(h>f){return f}return h};return e}());(function(){pandemix.TreePanel=function(){var O,d=undefined,J,aa,m,I=true,j,r,S,Q,T,h,X,w,V,C,A,ac,z,b,P,n,l,R,a,f,g,ad=30,p=20,F=5,H=8,M=20,G,v;function o(af,ae){var ah,ag;for(ah=0;ah<af.length;ah+=1){for(ag=0;ag<ae[0].length;ag+=1){if(af[ah]===ae[0][ag].__data__.target){af[ah].uplink=d3.select(ae[0][ag]);break}}}}function y(af){var ae=[],ag;for(ag=0;ag<af.length;ag+=1){if(af[ag].uplink){ae.push(af[ag].uplink)}}return ae}function ab(af){var ae=true,ag;while(ae){ae=false;for(ag=0;ag<af.length;ag+=1){if(af[ag].parent.children[0]===af[ag]){if(contains(af,af[ag].parent.children[1])&&!contains(af,af[ag].parent)){af.push(af[ag].parent);ae=true}}else{if(contains(af,af[ag].parent.children[0])&&!contains(af,af[ag].parent)){af.push(af[ag].parent);ae=true}}}}}function x(ah){var af;var ae=ah.slice(0);var ai=Infinity;ae.forEach(function(aj){if(aj.depth<ai){ai=aj.depth}});for(af=0;af<ae.length;af+=1){while(ae[af].depth>ai){ae[af]=ae[af].parent}}var ag=false;while(!ag){ag=true;for(af=1;af<ae.length;af+=1){if(ae[af]!==ae[0]){for(af=0;af<ae.length;af+=1){ae[af]=ae[af].parent}ag=false;break}}}return ae[0]}pandemix.nodeHeightToDate=function(af,ae){return new Date((ae-1970-af)*31557600000)};pandemix.dateToNodeHeight=function(af,ae){return ae-1970-af/31557600000};function K(ae){P.attr("x1",ae).attr("y1",S(v)).attr("x2",ae).attr("y2",0)}function W(ae){return"M"+r(ae.source.height)+","+S(ae.source.x)+"V"+S(ae.target.x)+"H"+r(ae.target.height)}function B(ae){return"M"+0+","+0+"h"+(r(ae.height)-r(C))}function t(af,ag){var ae;for(ae=0;ae<ag.length;ae+=1){if(ag[ae].name===af.name){ag.splice(ae,1);return}}console.log("removable element not found")}function E(ag,af){var ae=function(aj,al){var ak;al(aj);if(aj.children){for(ak=0;ak<aj.children.length;ak+=1){ae(aj.children[ak],al)}}};ae(ag[0],function(al){al.rootDist=(al.parent?al.parent.rootDist:0)+(al.length);var aj=al.height;var ak=al.parent?al.parent.height:0;var am=aj-ak;if(am>0){console.log(O+" "+am)}});console.log(O+" height span "+(V-C));var ai=ag.map(function(aj){return aj.rootDist});console.log(O+" length span "+d3.max(ai));var ah=d3.scale.linear().domain([0,d3.max(ai)]).range([0,af]);return ah}function U(){return navigator.appVersion.indexOf("Mac")!=-1}function q(){if(pandemix.focusedPanel!=O){pandemix.selectedNodes=[];pandemix.callUpdate("nodeSelectionUpdate");pandemix.selectedLeaves=[];pandemix.callUpdate("leafSelectionUpdate");Z()}pandemix.focusedPanel=O;if(d3.event.type==="touchstart"){l=[d3.touches(this)[0],[]]}else{l=[d3.mouse(this),[]]}d3.select(this.parentNode).append("rect").attr("id","extent").attr("x",l[0][0]).attr("y",l[0][1]).attr("width",0).attr("height",0);if(pandemix.brushHighlight){pandemix.selectedLeaves=[];pandemix.selectedPeriod=[0,0];d3.select(".axis").call(pandemix.globalTimeBrush.clear());pandemix.brushHighlight.remove();pandemix.brushHighlight=null;pandemix.callUpdate("leafSelectionUpdate");pandemix.callUpdate("timeSelectionUpdate")}d3.event.preventDefault()}function u(){if(l){if(d3.event.type==="touchmove"){l[1]=d3.touches(A.node())[0]}else{l[1]=d3.mouse(A[0][0])}if(l[1][0]>r(C)){l[1][0]=r(C)}if(l[1][1]>S(f-2*p)){l[1][1]=S(f-2*p)}d3.select("#extent").attr("x",d3.min([l[0][0],l[1][0]])).attr("y",d3.min([l[0][1],l[1][1]])).attr("width",Math.abs(l[1][0]-l[0][0])).attr("height",Math.abs(l[1][1]-l[0][1]))}}function D(){if(l){var ae,af;d3.select("#extent").remove();if(l[1][0]<l[0][0]){ae=l[0][0];l[0][0]=l[1][0];l[1][0]=ae}if(l[1][1]<l[0][1]){ae=l[0][1];l[0][1]=l[1][1];l[1][1]=ae}af=[];Q.each(function(ag){if(l[1][0]>r(ag.source.height)){if(ag.target.x>ag.source.x){if(l[0][1]<S(ag.target.x)&&(l[1][1]>S(ag.target.x)&&l[0][0]<r(ag.target.height)||l[0][0]<r(ag.source.height)&&l[1][1]>S(ag.source.x))){af.push(ag.target)}}else{if(l[1][1]>S(ag.target.x)&&(l[0][1]<S(ag.target.x)&&l[0][0]<r(ag.target.height)||l[0][0]<r(ag.source.height)&&l[0][1]<S(ag.source.x))){af.push(ag.target)}}}});if(af.length>1){Z(x(af))}else{if(af.length===1){Z(af[0])}else{Z()}}l=undefined;d3.event.preventDefault()}}function Z(af){if(!af){if(!d3.event.shiftKey){pandemix.selectedNodes=[];pandemix.callUpdate("nodeSelectionUpdate");pandemix.selectedLeaves=[];pandemix.callUpdate("leafSelectionUpdate")}}else{var ah=Y(af),ag,ae;if(!d3.event.shiftKey){pandemix.selectedLeaves=ah.slice(0)}else{for(ae=0;ae<ah.length;ae+=1){if(!pandemix.containsLeaf(pandemix.selectedLeaves,ah[ae])){pandemix.selectedLeaves.push(ah[ae])}}}pandemix.callUpdate("leafSelectionUpdate");ag=y(ah).concat(y(N(af)));if(!d3.event.shiftKey){Q.classed("highlighted",false)}if(af.depth!==Infinity){for(ae=0;ae<ag.length;ae+=1){ag[ae].classed("highlighted",true)}}}}function N(ag){var ae=[];if(ag.children){ae.push(ag);for(var af=0;af<ag.children.length;af++){ae=ae.concat(N(ag.children[af]))}}return ae}function e(ag,af){ag.parent=af;if(ag.children){for(var ae=0;ae<ag.children.length;ae++){e(ag.children[ae],ag)}}}function Y(ag){var ae=[];if(ag.children){for(var af=0;af<ag.children.length;af++){ae=ae.concat(Y(ag.children[af]))}}else{ae.push(ag)}return ae}var s={panelType:"treePanel",getColor:function(){return d},finishedLoading:false,panelID:undefined,treeData:undefined,maxHeight:function(){return V},minHeight:function(){return C},placePanel:function(ae){O=0+pandemix.counter;this.panelID=O;pandemix.focusedPanel=O;var af=d3.select(ae).classed("treePanel",true);if(af.classed("collapsible")){m=af.append("div").attr("class","panelControl");m.append("div").attr("class","panelControl collapseButton").on("click",function(){if(I){aa.style("display","none")}else{aa.style("display",null)}I=!I})}aa=af.append("div").attr("class","treePanel svgBox");a=parseInt(aa.style("width").replace(/\D+/,""),10);f=parseInt(aa.style("height").replace(/\D+/,""),10);j=aa.append("svg").attr("class","treeTopology").attr("width",a+"px").attr("height",f+"px");G=a-ad;v=f-2*p;pandemix.panels.push(s);pandemix.counter+=1},initializePanelData:function(ae){var af=this;d=ae.color||(function(){var ag=0;pandemix.panels.forEach(function(ah){if(ah.panelType==="treePanel"){ag+=1}});return pandemix.getHSBColor(ag,6,Math.floor(ag/6)*10)})();d3.json(ae.file,function(at){var ak,ap,au,aj,al,ao,an,ai,ah=/(.+)\.fullSet/;af.treeData=at;if(m){m.append("div").attr("class","panelControl name").text(at.name)}ac=parseFloat(at.origin);J=d3.layout.cluster().size([v,G]).separation(function(){return 1});e(at.root,undefined);ak=J.nodes(at.root);ap=J.links(ak);aj=[];for(al=0;al<ak.length;al+=1){if(!ak[al].children){aj.push(ak[al].height)}}C=d3.min(aj);V=at.root.height;ap.push();r=d3.scale.linear().domain([V,C]).range([0,G]);S=d3.scale.linear().domain([0,v]).range([0,v]);var ao=j.append("g").attr("transform","translate("+ad+","+p+")");P=ao.append("line").attr("class","aimLine");K(0);Q=ao.selectAll("path.link").data(ap,pandemix.getLinkKey).enter().append("path").attr("class","link").attr("d",W);o(ak,Q);ao.selectAll(".node").data(ak,pandemix.getNodeKey).enter().append("g").attr("class",function(av){if(av.children){if(av.depth===0){return"root inner node"}return"inner node"}return"leaf node"});T=ao.selectAll(".inner");ao.select(".root").append("path").attr("class","rootLink").attr("d",function(){return"M"+0+","+0+"h"+-20});h=ao.selectAll(".leaf");var ar=v/h.size();h.append("text").attr("class","leafText").attr("dx",H).attr("text-anchor","start").text(function(av){return av.name});var aq=0;h.each(function(){var av=d3.select(this).select("text")[0][0].getComputedTextLength();if(av>aq){aq=av}});G=G-H-aq-M;r.range([0,G]);h.append("path").attr("class","dashedLink").attr("d",B);h.append("rect").attr("class","leafBack").attr("y",-ar/2).attr("x",F).attr("width",aq+F).attr("height",ar).on("click",function(){pandemix.focusedPanel=O;var ay=d3.select(this.parentNode);Q.classed("highlighted",false);if(d3.event.metaKey||d3.event.ctrlKey){X=ay;var az=!ay.classed("highlighted");ay.classed("highlighted",az);az?pandemix.selectedLeaves.push(ay.datum()):t(ay.datum(),pandemix.selectedLeaves);if(az){pandemix.callUpdate("focusUpdate",ay)}}else{if(d3.event.shiftKey){var ax=X?X.datum().x:0;var aw=ay.datum().x;if(ax>aw){var av=aw;aw=ax;ax=av}pandemix.selectedLeaves=[];h.each(function(aA){if(ax<=aA.x&&aA.x<=aw){pandemix.selectedLeaves.push(aA)}})}else{X=ay;pandemix.selectedLeaves=[ay.datum()];pandemix.callUpdate("focusUpdate",ay)}}pandemix.callUpdate("leafSelectionUpdate")});h.each(function(av){if(!pandemix.globalData.hasOwnProperty(av.name)){pandemix.globalData[av.name]={height:av.height};pandemix.taxa.add([{name:av.name,date:pandemix.nodeHeightToDate(av.height,ac),location:av.location||""}])}});for(al=0;al<pandemix.panels.length;al+=1){if(pandemix.panels[al].panelType==="legendPanel"){for(ai in at){if(at.hasOwnProperty(ai)){var am=ah.exec(ai);if(am){var ag={};ag[am[1]]=at[ai].map(function(av){return{name:av,color:undefined}});pandemix.panels[al].addTraits(ag)}}}pandemix.panels[al].addTraits({Tree:[{name:at.name,color:d}]})}}for(al=0;al<pandemix.panels.length;al+=1){if(pandemix.panels[al].panelType==="traitSelectionPanel"){for(ai in at){if(at.hasOwnProperty(ai)){var am=ah.exec(ai);if(am){pandemix.panels[al].addTraits([am[1]])}}}pandemix.panels[al].addTraits(["Tree"])}}A=ao.append("rect").attr("width",G).attr("height",v).attr("class","brushBox").on("mousedown",q).on("touchstart",q).on("touchmove",u).on("touchend",D);d3.select(document).on("mousemove.treeSelect"+O,u).on("mouseup.treeSelect"+O,D);z=d3.time.scale().domain([pandemix.nodeHeightToDate(V,ac),pandemix.nodeHeightToDate(C,ac)]).range([0,G]);z.clamp(true);an=d3.svg.axis().scale(z).orient("bottom");b=ao.append("g").attr("class","axis").call(an);pandemix.panels.forEach(function(av){if(av.panelType==="timePanel"){av.updateGlobalTimeAxis(pandemix.nodeHeightToDate(V,ac),pandemix.nodeHeightToDate(C,ac))}});pandemix.nodes.add(ak.map(function(av){return{node:av,date:pandemix.nodeHeightToDate(av.height,ac),treeID:O,color:d}}));pandemix.links.add(ap.map(function(av){return{link:av,startDate:pandemix.nodeHeightToDate(av.source.height,ac),endDate:pandemix.nodeHeightToDate(av.target.height,ac),treeID:O,color:d,treeName:at.name||""}}));s.zoomUpdate();af.finishedLoading=true})},leafSelectionUpdate:function(){w=h.filter(function(ae){return pandemix.containsLeaf(pandemix.selectedLeaves,ae)});h.classed("highlighted",false);w.classed("highlighted",true)},leafColorUpdate:function(ae){w.select("text").style("fill",ae[1])},timeSelectionUpdate:function(){if(n){n.attr("x",z(pandemix.selectedPeriod[0])||0).attr("width",(z(pandemix.selectedPeriod[1])-z(pandemix.selectedPeriod[0]))||0)}else{n=j.select("g").append("rect").attr("class","timeSelection").attr("x",z(pandemix.selectedPeriod[0])).attr("y",0).attr("height","100%").attr("width",z(pandemix.selectedPeriod[1])-z(pandemix.selectedPeriod[0]))}},nodeSelectionUpdate:function(){Q.classed("highlighted",false);for(var ae=0;ae<pandemix.selectedNodes.length;ae+=1){pandemix.selectedNodes[ae].uplink.classed("highlighted",true)}},traitSelectionUpdate:function(){if(pandemix.traitType&&pandemix.traitValues){Q.style("stroke",function(af){for(var ae=0;ae<pandemix.traitValues.length;ae+=1){if(af.target[pandemix.traitType]===pandemix.traitValues[ae].name){return pandemix.traitValues[ae].color}}return null})}},zoomUpdate:function(){S.range([0,v*pandemix.scale]);if(pandemix.scale===1){aa.style("overflow-y","hidden")}else{aa.style("overflow-y","auto")}j.attr("height",S(v)+2*p);b.attr("transform","translate(0,"+S(v)+")");if(pandemix.selectedDate){K(z(pandemix.selectedDate))}A.attr("height",S(v));Q.attr("d",W);T.attr("transform",function(af){return"translate("+r(af.height)+","+S(af.x)+")"});h.attr("transform",function(af){return"translate("+r(C)+","+S(af.x)+")"});var ae=S(v)/h.size();j.selectAll(".leafBack").attr("y",-ae/2).attr("height",ae)},focusUpdate:function(ae){if(O!==pandemix.focusedPanel){var af=h.filter(function(ag){return ae[1].datum().name===ag.name});if(!af.empty()){aa[0][0].scrollTop=S(af.datum().x)-f/2}}},timeSlideUpdate:function(){if(z){K(z(pandemix.selectedDate))}}};return s}})();(function(){pandemix.TraitSelectionPanel=function(){var f,o,e,g,l=0,j=0+pandemix.counter,m=["No trait"],h,d=1,b=2;pandemix.counter+=1;function n(){var p=g.selectAll(".traitRow").data(m,function(r){return r});var q=p.enter().append("g").attr("class","traitRow").on("click",function(r){g.selectAll(".traitRow").select(".traitRowBackground").classed("selected",false);d3.select(this).select(".traitRowBackground").classed("selected",true);pandemix.traitType=r;pandemix.callUpdate("traitTypeUpdate")});q.append("rect").attr("class","traitRowBackground").attr("y",-h).attr("height",h).attr("width","100%");q.select(".traitRowBackground").classed("selected",function(r){return r==="No trait"});q.append("text").attr("class","traitRowText").attr("dy",-1).text(function(r){return r});p.attr("transform",function(s,r){return"translate(0,"+((r+1)*(h+d))+")"});p.exit().remove()}var a={panelType:"traitSelectionPanel",placePanel:function(p){e=d3.select(p.target).classed("traitSelectionPanel",true);f=parseInt(e.style("width").replace(/\D+/,""),10);o=parseInt(e.style("height").replace(/\D+/,""),10);h=parseInt(e.style("font-size").replace(/\D+/,""),10);g=e.append("svg").attr("class","traitSvg").attr("width",f).attr("height",o);pandemix.panels.push(a)},addTraits:function(t){var r=false,q,s;for(q=0;q<t.length;q+=1){var p=false;for(s=0;s<m.length;s+=1){if(m[s]===t[q]){p=true;break}}if(!p){m.push(t[q]);r=true}}if(r){n()}}};return a}})();(function(){pandemix.LegendPanel=function(){var g,q,f,j,n=0,m=0+pandemix.counter,o={"No trait":[]},l,e=1,d=2,b=g,h=q;pandemix.counter+=1;function p(s){if(!s||!(s in o)){return}var u=function(){var x=o[s];var v=[];for(var w=0;w<x.length;w+=1){v.push({name:x[w].name,color:x[w].color||pandemix.getHSBColor(w,x.length),colorIsStatic:!!x[w].color,selected:true})}return v}();var r=j.selectAll(".traitRow").data(u,function(v){return v.name});var t=r.enter().append("g").attr("class","traitRow").on("click",function(v){if(!v.colorIsStatic){v.selected=!v.selected;pandemix.traitType=s;pandemix.traitValues=[];j.selectAll(".traitRow").each(function(w){if(w.selected){pandemix.traitValues.push(w)}});pandemix.callUpdate("traitSelectionUpdate");j.selectAll(".traitRow").select(".legendIcon").style("fill",function(w){if(w.selected){return w.color}return"gray"})}});t.append("rect").attr("class","traitRowBackground").attr("y",-l).attr("height",l).attr("width","100%").style("fill-opacity",0);t.append("rect").attr("class","legendIcon").attr("y",-l).attr("height",l).attr("width",l).style("fill",function(v){return v.color});t.append("text").attr("class","legendRowText").attr("x",(l+d)).text(function(v){return v.name});r.attr("transform",function(w,v){return"translate(0,"+((v+1)*(l+e))+")"});r.exit().remove();h=r.size()*(l+e);j.attr("height",d3.max([q,h]));if(h<q){f.style("overflow-y","hidden")}else{f.style("overflow-y",null)}r.select(".legendIcon").style("fill",function(v){if(v.selected){return v.color}return"gray"})}var a={panelType:"legendPanel",placePanel:function(r){f=d3.select(r.target).classed("legendPanel",true);g=parseInt(f.style("width").replace(/\D+/,""),10);q=parseInt(f.style("height").replace(/\D+/,""),10);l=parseInt(f.style("font-size").replace(/\D+/,""),10);j=f.append("svg").attr("class","legendSvg").attr("width",g).attr("height",q);pandemix.panels.push(a)},addTraits:function(v){var t=false,s;for(var r in v){if(v.hasOwnProperty(r)){if(o.hasOwnProperty(r)){for(s=0;s<v[r].length;s+=1){var u=pandemix.accContains(o[r],v[r][s],function(w){return w.name},function(w){return w.name});if(!u){o[r].push(v[r][s]);t=true}}}else{o[r]=v[r].slice(0);t=true}}}if(t){p("No trait")}},getTraits:function(){return o},traitTypeUpdate:function(){p(pandemix.traitType);pandemix.traitValues=[];j.selectAll(".traitRow").each(function(r){if(r.selected){pandemix.traitValues.push(r)}});pandemix.callUpdate("traitSelectionUpdate")}};return a}})();(function(){var n,h,g,f=[],q=[],j,o,b,d,e,p,a,m=0+pandemix.counter,l;pandemix.counter+=1;pandemix.TimePanel=function(){function y(){d3.selectAll("path.link").classed("highlighted",false)}function x(){var A=j.extent();pandemix.selectedPeriod=A;if(pandemix.brushHighlight){o.attr("x",h(A[0])).attr("width",h(A[1])-h(A[0]))}else{o=n.append("rect").attr("class","timeSelection").attr("x",h(A[0])).attr("y",0).attr("width",h(A[1])-h(A[0])).attr("height",a);pandemix.brushHighlight=o}pandemix.locDim.filter(null);pandemix.selectedLeaves=pandemix.dateDim.filterRange(A).top(Infinity);pandemix.callUpdate("timeSelectionUpdate");pandemix.callUpdate("leafSelectionUpdate")}function u(){if(j.empty()){if(o){o.remove();o=null;pandemix.brushHighlight=null}}}var v=false;var z=undefined;var r=undefined;function w(){d3.event.preventDefault();v=true;if(o){o.remove();o=null;pandemix.brushHighlight=null;pandemix.selectedPeriod=[];pandemix.selectedLeaves=[];pandemix.callUpdate("timeSelectionUpdate");pandemix.callUpdate("leafSelectionUpdate")}var A;if(d3.event.type==="touchstart"){A=d3.touches(z.node())[0][0]}else{A=d3.mouse(z.node())[0]}if(A>p){A=p}else{if(A<0){A=0}}r.style("left",(A-e/2)+"px");pandemix.selectedDate=h.invert(A);pandemix.callUpdate("timeSlideUpdate")}function s(){if(v){var A;if(d3.event.type==="touchmove"){A=d3.touches(z.node())[0][0]}else{A=d3.mouse(z.node())[0]}if(A>p){A=p}else{if(A<0){A=0}}r.style("left",(A-e/2)+"px");pandemix.selectedDate=h.invert(A);d3.select("body").selectAll("span.date-calendar").text(pandemix.selectedDate.toDateString().substring(4));pandemix.callUpdate("timeSlideUpdate")}}function t(){if(v){v=false}}b={panelType:"timePanel",updateGlobalTimeAxis:function(A,B){f.push(A);q.push(B);pandemix.minDate=d3.min(f);pandemix.maxDate=d3.max(q);pandemix.selectedDate=new Date(pandemix.minDate.getTime());h.domain([d3.min(f),d3.max(q)]);n.call(g)},placePanel:function(A){d=d3.select(A.target).classed("timePanel",true);z=d.append("div").attr("class","sliderBackground").on("mousedown.time",w).on("touchstart.time",w).on("touchmove.time",s).on("touchend.time",t);d3.select(document).on("mousemove.time",s).on("mouseup.time",t);r=z.append("div").attr("class","timeSlider");e=parseInt(r.style("width").replace(/\D+/,""),10);r.style("left",(-e/2)+"px");n=d.append("svg").attr("class","timeLine");p=parseInt(n.style("width").replace(/\D+/,""),10);a=parseInt(n.style("height").replace(/\D+/,""),10);l=n.append("line").attr("class","aimLine").attr("x1","0").attr("x2","0").attr("y1","0").attr("y2",a);h=d3.time.scale().domain([0,1]).range([0,p]).clamp(true);g=d3.svg.axis().scale(h).orient("bottom");j=d3.svg.brush().x(h).on("brushstart",y).on("brush",x).on("brushend",u);pandemix.globalTimeBrush=j;n.call(j).call(g);pandemix.panels.push(b)},timeSlideUpdate:function(){l.attr("x1",h(pandemix.selectedDate)).attr("x2",h(pandemix.selectedDate));if(!v){var A=h(pandemix.selectedDate);if(A>p){A=p}else{if(A<0){A=0}}var B=(A-e/2);r.style("left",B+"px")}}};return b}})();(function(){pandemix.MapPanel=function(){var g,d=[[-180,-90],[180,90]],f=[],a,h=undefined,e={};contoursLoaded=false,centroidsLoaded=false,previousSelectedDate=undefined,panelID=0+pandemix.counter,zCounter=10,info=undefined;pandemix.counter+=1;var b={panelType:"mapPanel",placePanel:function(l){var j=l.initCoords||[0,0];var m=l.initZoom||4;g=new L.Map(l.target,{center:j,zoom:m,maxBounds:[[-90,-180],[90,180]]});a=L.control.layers(null,null).addTo(g);pandemix.panels.push(b);return b},loadContours:function(j){var l=this;d3.json(j,function(m){var n=d3.geo.path().projection(l.project);h=m;contoursLoaded=true});return b},loadCentroids:function(j){var l=this;if(!j){pandemix.when(function(){return contoursLoaded},function(){var o=d3.geo.path().projection(l.project);for(var m=0;m<h.features.length;m++){var n=o.centroid(h.features[m]);if(n){n=g.layerPointToLatLng(new L.Point(n[0],n[1]));e[h.features[m].properties.name]=[n.lng,n.lat]}}centroidsLoaded=true},100)}else{d3.csv(j,function(m){m.forEach(function(n){e[n.location]=[n.longitude,n.latitude]});centroidsLoaded=true})}return b},addTileLayer:function(m){var j=new L.TileLayer(m,{noWrap:true,zIndex:zCounter});zCounter+=1;g.addLayer(j);a.addOverlay(j,"Tiles");return b},addLayer:function(m){var n=this;var m=m;if(!m.zIndex){m.zIndex=zCounter;zCounter+=1}var j=new m.layerType();pandemix.when(function(){var l=true;if(j.needsContours){l=l&&contoursLoaded}if(j.needsCentroids){l=l&&centroidsLoaded}if(j.needsTrees){l=l&&pandemix.panelsLoaded("treePanel")}return l},function(){var l="layer";if(m.name){l=m.name}else{if(j.needsTrees){l=m.treePanel.treeData.name}}m.map=g;m.project=n.project;m.bounds=d;m.mapData=h;m.centroids=e;a.addOverlay(j,l);j.initDraw(m);g.addLayer(j);f.push(j)},100);return b},addInfoDisplay:function(j){info=L.control({position:"bottomleft"});info.onAdd=function(l){this.div=L.DomUtil.create("div","info");return this.div};info.update=j;info.addTo(g);return b},getMap:function(){return g},leafSelectionUpdate:function(){var l=[],j;for(j=0;j<pandemix.selectedLeaves.length;j+=1){if(!pandemix.contains(l,pandemix.selectedLeaves[j].location)){l.push(pandemix.selectedLeaves[j].location)}}for(j=0;j<f.length;j+=1){if("leafSelectionUpdate" in f[j]){f[j].leafSelectionUpdate(l)}}},mapLegendUpdate:function(){if(info){if(arguments[0].length>1){info.div.innerHTML=info.update(arguments[0][1])}else{info.div.innerHTML=""}}},timeSelectionUpdate:function(){},timeSlideUpdate:function(){var j=pandemix.selectedDate;var n=undefined;var l=undefined;if(!previousSelectedDate){l=true}else{l=previousSelectedDate<j}previousSelectedDate=new Date(j.getTime());if(arguments[0].length>1){l=arguments[0][1]}for(i=0;i<f.length;i+=1){if("timeSlideUpdate" in f[i]){if(!n){pandemix.linkStartDateDim.filter(function(o){return o<j});var m=pandemix.linkEndDateDim.filter(function(o){return o>=j}).top(Infinity)}f[i].timeSlideUpdate(m,l)}}},traitSelectionUpdate:function(){for(var j=0;j<f.length;j+=1){if("traitSelectionUpdate" in f[j]){f[j].traitSelectionUpdate()}}},project:function(l){var j=g.latLngToLayerPoint([l[1],l[0]]);return[j.x,j.y]}};return b}})();(function(){pandemix.map.regionOutlineLayer=L.Class.extend({needsContours:true,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.project=a.project;b.bounds=a.bounds;b.el=L.DomUtil.create("div","provinceLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){d3.event.preventDefault()});b.g=b.svg.append("g");d(a.mapData);function d(e){b.path=d3.geo.path().projection(b.project);b.feature=b.g.selectAll(".mapPath").data(e.features).enter().append("path").attr("class","mapPath").on("click",function(f){pandemix.dateDim.filter(null);pandemix.selectedLeaves=pandemix.locDim.filter(f.properties.name).top(Infinity);pandemix.callUpdate("leafSelectionUpdate");d3.select(this).classed("mapHighlighted",true)})}b.reset();b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},onAdd:function(){var a=this;a.svg.style("display",null);a.map.on("viewreset",a.reset,a);a.reset()},onRemove:function(){var a=this;a.svg.style("display","none");a.map.off("viewreset",a.reset,a)},reset:function(){var d=this;var a=d.project(d.bounds[0]),b=d.project(d.bounds[1]);d.svg.attr("width",Math.abs(b[0]-a[0])).attr("height",Math.abs(a[1]-b[1])).style("margin-left",a[0]+"px").style("margin-top",b[1]+"px");d.g.attr("transform","translate("+-a[0]+","+-b[1]+")");d.feature.attr("d",d.path)},leafSelectionUpdate:function(a){this.feature.classed("mapHighlighted",function(b){return pandemix.contains(a,b.properties.name)})}})})();(function(){pandemix.map.locationLayer=L.Class.extend({needsCentroids:true,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.project=a.project;b.bounds=a.bounds;b.centroids=a.centroids;b.unitRadius=a.unitRadius||1;b.minR=a.minRadius;b.maxR=a.maxRadius;b.displayedProperty=a.displayedProperty||"location";b.el=L.DomUtil.create("div","locationLayer leaflet-zoom-hide");d3.select(b.el).style("position","absolute").style("z-index",a.zIndex);b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){d3.event.preventDefault()});b.g=b.svg.append("g");var d=[];for(c in b.centroids){if(b.centroids.hasOwnProperty(c)){d.push({size:0,name:c,center:[b.centroids[c][0],b.centroids[c][1]]})}}b.circles=b.g.selectAll("circle.location").data(d).enter().append("circle").attr("class","location");b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none");pandemix.when(function(){return pandemix.panelsLoaded("treePanel")},function(){var f={};function e(h){if(h.children){for(var g=0;g<h.children.length;g+=1){e(h.children[g])}}else{if(f[h[b.displayedProperty]]){f[h[b.displayedProperty]]+=1}else{f[h[b.displayedProperty]]=1}}}pandemix.panels.forEach(function(g){if(g.panelType==="treePanel"){e(g.treeData.root)}});d.forEach(function(g){g.size=f[g.name]});b.reset()},100)},onAdd:function(b){var a=this;a.svg.style("display",null);b.on("viewreset",a.reset,a);a.reset()},onRemove:function(b){var a=this;a.svg.style("display","none");b.off("viewreset",a.reset,a)},reset:function(){var d=this;var a=d.project(d.bounds[0]),b=d.project(d.bounds[1]);d.svg.attr("width",Math.abs(b[0]-a[0])).attr("height",Math.abs(a[1]-b[1])).style("margin-left",a[0]+"px").style("margin-top",b[1]+"px");d.unitArea=d.unitRadius*d.unitRadius*Math.PI*Math.pow(4,d.map.getZoom()-d.map.getMinZoom());d.minr=d.minR*Math.pow(2,d.map.getZoom()-d.map.getMinZoom());d.maxr=d.maxR*Math.pow(2,d.map.getZoom()-d.map.getMinZoom());d.g.attr("transform","translate("+-a[0]+","+-b[1]+")");d.circles.attr("cx",function(e){return d.project(e.center)[0]}).attr("cy",function(e){return d.project(e.center)[1]}).attr("r",function(e){return pandemix.clamp(Math.sqrt(d.unitArea*e.size/Math.PI),d.minr,d.maxr)})},traitSelectionUpdate:function(){var a=this;if(pandemix.traitValues){a.circles.style("fill",function(e){for(var b=0;b<pandemix.traitValues.length;b+=1){if(e.name===pandemix.traitValues[b].name){return pandemix.traitValues[b].color}}return null})}}})})();(function(){var a=function(e){return e.color};var b=a;pandemix.map.virusParticleLayer=L.Class.extend({needsCentroids:true,needsTrees:true,virNum:0,initialize:function(){},initDraw:function(d){var e=this;e.map=d.map;e.tree=d.treePanel.treeData.root;e.project=d.project;e.centroids=d.centroids;e.currNodes=[e.tree];e.treeID=d.treePanel.panelID;e.foci=[];e.bounds=d.bounds;e.initRadius=d.radius||1;e.chargeDensity=-Math.abs(d.chargeDensity)||-0.1;e.el=L.DomUtil.create("div","virusParticleLayer leaflet-zoom-hide");d3.select(e.el).style("position","absolute").style("z-index",d.zIndex);e.svg=d3.select(e.el).append("svg");e.svg.on("mousedown",function(){d3.event.preventDefault()});e.g=e.svg.append("g");e.nodes=[];e.force=d3.layout.force().nodes(e.nodes).links([]).gravity(0).charge(function(f){console.log(f.r);return e.chargeDensity*f.r*f.r}).friction(0.85);e.force.on("tick",function(g){var f=0.1*g.alpha;e.nodes.forEach(function(j,h){j.y+=(e.foci[j.id].y-j.y)*f;j.x+=(e.foci[j.id].x-j.x)*f});e.g.selectAll("circle.virusParticle").attr("cx",function(h){return h.x}).attr("cy",function(h){return h.y})});e.map.getPanes().overlayPane.appendChild(e.el);e.svg.style("display","none")},timeSlideUpdate:function(l,f){var h=this;var j=undefined;var m=[];var d;l.forEach(function(n){if(n.treeID===h.treeID){m.push(n.link);j=n.color}});var e=[];m.forEach(function(n){var p=false;var o=undefined;var q=undefined;for(d=0;d<h.nodes.length;d+=1){if(h.nodes[d].node===n.target){p=true;e.push(h.nodes[d]);break}if(f&&h.nodes[d].node===n.source){o=[h.nodes[d].x,h.nodes[d].y];q=d}}if(!p){for(d=0;d<h.foci.length;d+=1){if(h.foci[d].name===n.target.location){if(f&&!o){o=h.project(h.centroids[n.source.location])}else{if(!f){o=h.project(h.centroids[n.target.location])}}e.push({virNum:h.virNum,id:d,x:o[0],y:o[1],r:h.radius,node:n.target,color:j});h.virNum+=1;break}}}});h.nodes=e;h.force.nodes(e);h.force.start();var g=h.g.selectAll("circle.virusParticle").data(h.nodes,function(n){return n.virNum});g.exit().remove();g.enter().append("svg:circle").attr("class","virusParticle").attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}).style("fill",b).style("stroke",1).attr("r",function(n){return n.r})},onAdd:function(e){var d=this;d.svg.style("display",null);e.on("viewreset",d.reset,d);d.reset()},onRemove:function(e){var d=this;d.svg.style("display","none");e.off("viewreset",d.reset,d)},reset:function(){var j=this,d,g;if(j.force){j.force.stop()}var e=j.project(j.bounds[0]),f=j.project(j.bounds[1]);d=f[0]-e[0];g=e[1]-f[1];j.svg.attr("width",d).attr("height",g).style("margin-left",e[0]+"px").style("margin-top",f[1]+"px");j.g.attr("transform","translate("+-e[0]+","+-f[1]+")");j.radius=j.initRadius*Math.pow(2,j.map.getZoom()-j.map.getMinZoom());var l=j.foci.slice(0);j.foci=[];for(c in j.centroids){if(j.centroids.hasOwnProperty(c)){j.foci.push({name:c,x:j.project(j.centroids[c])[0],y:j.project(j.centroids[c])[1],occupants:[],size:0})}}if(j.nodes){j.nodes.forEach(function(h){h.x+=j.foci[h.id].x-l[h.id].x;h.y+=j.foci[h.id].y-l[h.id].y;h.px=h.x;h.py=h.y;h.r=j.radius})}j.g.selectAll("circle.virusParticle").attr("cx",function(h){return h.x}).attr("cy",function(h){return h.y}).attr("r",function(h){return h.r});if(j.force){j.force.start()}return[d,g]},traitSelectionUpdate:function(){var d=this;i=0;pandemix.panels.forEach(function(e){if(e.panelType==="treePanel"){i+=1}});if(i===1&&pandemix.traitType.toLowerCase()==="location"&&pandemix.traitValues){b=function(e){for(i=0;i<pandemix.traitValues.length;i+=1){if(e.node.location===pandemix.traitValues[i].name){return pandemix.traitValues[i].color}}return null}}else{b=a}d.g.selectAll("circle.virusParticle").style("fill",b)}})})();(function(){var a=function(e){return e.color};var b=a;pandemix.map.bubbleChartLayer=L.Class.extend({needsCentroids:true,virNum:0,initialize:function(){},initDraw:function(d){var e=this;e.map=d.map;e.tree=d.tree;e.project=d.project;e.centroids=d.centroids;e.color=d.color;e.foci=[];e.bounds=d.bounds;e.unitRadius=d.unitRadius||1;e.minR=d.minRadius;e.maxR=d.maxRadius;e.chargeDensity=-Math.abs(d.chargeDensity)||-0.1;e.prevData={};e.el=L.DomUtil.create("div","bubbleChartLayer leaflet-zoom-hide");d3.select(e.el).style("position","absolute").style("z-index",d.zIndex);e.svg=d3.select(e.el).append("svg");e.svg.on("mousedown",function(){d3.event.preventDefault()});e.g=e.svg.append("g");e.nodes=[];e.force=d3.layout.force().nodes(e.nodes).links([]).gravity(0).charge(function(f){return e.chargeDensity*f.r*f.r});e.force.on("tick",function(g){var f=0.1*g.alpha;e.nodes.forEach(function(j,h){j.y+=(e.foci[j.id].y-j.y)*f;j.x+=(e.foci[j.id].x-j.x)*f});e.g.selectAll("circle.bubble").attr("cx",function(h){return h.x}).attr("cy",function(h){return h.y})});e.map.getPanes().overlayPane.appendChild(e.el);e.svg.style("display","none")},timeSlideUpdate:function(j){var g=this;var d;var e=[];var h={};j.forEach(function(q){var m=q.link;var o=[m.target.location,q.treeID];if(h.hasOwnProperty(o)){h[o].size+=1;h[o].infoData.number+=1}else{for(d=0;d<g.foci.length;d+=1){if(g.foci[d].name===m.target.location){var n=[];var r=0;if(g.prevData.hasOwnProperty(o)){n[0]=g.prevData[o].x;n[1]=g.prevData[o].y;r=g.prevData[o].size}else{n=g.project(g.centroids[m.target.location])}var p={location:m.target.location,number:1,treeName:q.treeName};h[o]={key:o,id:d,x:n[0],y:n[1],size:1,prevSize:r,color:q.color,infoData:p};break}}}});g.prevData=h;for(k in h){if(h.hasOwnProperty(k)){e.push(h[k])}}e.forEach(function(l){l.r=pandemix.clamp(Math.sqrt(g.unitArea*l.size/Math.PI),g.minr,g.maxr)});g.nodes=e;g.force.nodes(e);g.force.start();var f=g.g.selectAll("circle.bubble").data(g.nodes,function(l){return l.key});f.exit().transition().attr("r",0.1).remove();f.enter().append("svg:circle").attr("class","bubble").attr("cx",function(l){return l.x}).attr("cy",function(l){return l.y}).style("fill",b).attr("r",0.1).on("mouseover",function(l){pandemix.callUpdate("mapLegendUpdate",l.infoData)}).on("mouseout",function(){pandemix.callUpdate("mapLegendUpdate")});f.transition().delay(function(l){return l.prevSize>l.size?0:250}).attr("r",function(l){return l.r})},onAdd:function(e){var d=this;d.svg.style("display",null);e.on("viewreset",d.reset,d);d.reset()},onRemove:function(e){var d=this;d.svg.style("display","none");e.off("viewreset",d.reset,d)},reset:function(){var j=this,d,g;if(j.force){j.force.stop()}var e=j.project(j.bounds[0]),f=j.project(j.bounds[1]);d=f[0]-e[0];g=e[1]-f[1];j.svg.attr("width",d).attr("height",g).style("margin-left",e[0]+"px").style("margin-top",f[1]+"px");j.g.attr("transform","translate("+-e[0]+","+-f[1]+")");var l=j.foci.slice(0);j.foci=[];for(c in j.centroids){if(j.centroids.hasOwnProperty(c)){j.foci.push({name:c,x:j.project(j.centroids[c])[0],y:j.project(j.centroids[c])[1]})}}j.unitArea=j.unitRadius*j.unitRadius*Math.PI*Math.pow(4,j.map.getZoom()-j.map.getMinZoom());j.minr=j.minR*Math.pow(2,j.map.getZoom()-j.map.getMinZoom());j.maxr=j.maxR*Math.pow(2,j.map.getZoom()-j.map.getMinZoom());if(j.nodes){j.nodes.forEach(function(h){h.x+=j.foci[h.id].x-l[h.id].x;h.y+=j.foci[h.id].y-l[h.id].y;h.px=h.x;h.py=h.y;h.r=pandemix.clamp(Math.sqrt(j.unitArea*h.size/Math.PI),j.minr,j.maxr)})}j.g.selectAll("circle.bubble").attr("cx",function(h){return h.x}).attr("cy",function(h){return h.y}).attr("r",function(h){return h.r});if(j.force){j.force.start()}return[d,g]},traitSelectionUpdate:function(){var d=this;i=0;pandemix.panels.forEach(function(e){if(e.panelType==="treePanel"){i+=1}});if(i===1&&pandemix.traitType.toLowerCase()==="location"&&pandemix.traitValues){b=function(e){for(i=0;i<pandemix.traitValues.length;i+=1){if(e.key[0]===pandemix.traitValues[i].name){return pandemix.traitValues[i].color}}return null}}else{b=a}d.g.selectAll("circle.bubble").style("fill",b)}})})();(function(){var a=function(e){return e.color};var b=a;pandemix.map.bubbleTransLayer=L.Class.extend({needsCentroids:true,virNum:0,initialize:function(){},initDraw:function(d){var e=this;e.map=d.map;e.tree=d.tree;e.project=d.project;e.centroids=d.centroids;e.currNodes=[e.tree];e.color=d.color;e.foci=[];e.bounds=d.bounds;e.initRadius=d.radius||1;e.el=L.DomUtil.create("div","bubbleTransLayer leaflet-zoom-hide");d3.select(e.el).style("position","absolute").style("z-index",d.zIndex);e.svg=d3.select(e.el).append("svg");e.svg.on("mousedown",function(){d3.event.preventDefault()});e.g=e.svg.append("g");e.nodes=[];e.map.getPanes().overlayPane.appendChild(e.el);e.svg.style("display","none")},timeSlideUpdate:function(j,f){var h=this;var d;var e=[];var l=[];j.forEach(function(p){var m=p.link;l.push(m.target);var o=false;for(d=0;d<h.nodes.length;d+=1){if(h.nodes[d]===m.target){o=true;break}}if(!o){var n,q;if(f){if(m.source.location!==m.target.location){q=h.project(h.centroids[m.target.location]);n=h.project(h.centroids[m.source.location]);e.push({targX:q[0],targY:q[1],initX:n[0],initY:n[1],loc:m.target.location,r:h.radius,treeID:p.treeID,color:p.color})}}else{if(m.target.children){m.target.children.forEach(function(r){if(r.location!==m.target.location){n=h.project(h.centroids[r.location]);q=h.project(h.centroids[m.target.location]);e.push({targX:q[0],targY:q[1],initX:n[0],initY:n[1],loc:m.target.location,r:h.radius,treeID:p.treeID,color:p.color})}})}}}});h.nodes=l;var g=h.g.selectAll("circle.bubbleTrans").data(e);g.enter().append("svg:circle").attr("class","bubbleTrans").attr("cx",function(m){return m.initX}).attr("cy",function(m){return m.initY}).style("fill",b).attr("r",function(m){return m.r}).transition().ease("linear").duration(500).attr("cx",function(m){return m.targX}).attr("cy",function(m){return m.targY}).remove()},onAdd:function(e){var d=this;d.svg.style("display",null);e.on("viewreset",d.reset,d);d.reset()},onRemove:function(e){var d=this;d.svg.style("display","none");e.off("viewreset",d.reset,d)},reset:function(){var j=this,d,g;var e=j.project(j.bounds[0]),f=j.project(j.bounds[1]);d=f[0]-e[0];g=e[1]-f[1];j.svg.attr("width",d).attr("height",g).style("margin-left",e[0]+"px").style("margin-top",f[1]+"px");j.g.attr("transform","translate("+-e[0]+","+-f[1]+")");j.radius=Math.pow(2,j.map.getZoom()-j.map.getMinZoom())*j.initRadius;j.g.selectAll("circle.bubbleTrans").attr("r",j.radius);j.foci=[];for(c in j.centroids){if(j.centroids.hasOwnProperty(c)){j.foci.push({name:c,x:j.project(j.centroids[c])[0],y:j.project(j.centroids[c])[1],occupants:[],size:0})}}return[d,g]},traitSelectionUpdate:function(){var d=this;i=0;pandemix.panels.forEach(function(e){if(e.panelType==="treePanel"){i+=1}});if(i===1&&pandemix.traitType.toLowerCase()==="location"&&pandemix.traitValues){b=function(e){for(i=0;i<pandemix.traitValues.length;i+=1){if(e.loc===pandemix.traitValues[i].name){return pandemix.traitValues[i].color}}return null}}else{b=a}d.g.selectAll("circle.bubbleTrans").style("fill",b)}})})();(function(){pandemix.map.treeLayer=L.Class.extend({needsCentroids:true,needsTrees:true,initialize:function(){},initDraw:function(a){var b=this;b.map=a.map;b.project=a.project;b.bounds=a.bounds;b.centroids=a.centroids;b.path=d3.geo.path().projection(b.project);b.color=a.color;b.el=L.DomUtil.create("div","treeLayer leaflet-zoom-hide");d3.select(b.el).style("z-index",a.zIndex).style("position","absolute");b.svg=d3.select(b.el).append("svg");b.svg.on("mousedown",function(){d3.event.preventDefault()});b.g=b.svg.append("g");b.drawTree(a.treePanel.treeData.root);b.map.getPanes().overlayPane.appendChild(b.el);b.svg.style("display","none")},onAdd:function(b){var a=this;a.svg.style("display",null);b.on("viewreset",a.reset,a);a.reset()},onRemove:function(b){var a=this;a.svg.style("display","none");b.off("viewreset",a.reset,a)},reset:function(){var d=this;var a=d.project(d.bounds[0]),b=d.project(d.bounds[1]);d.svg.attr("width",b[0]-a[0]).attr("height",a[1]-b[1]).style("margin-left",a[0]+"px").style("margin-top",b[1]+"px");d.g.attr("transform","translate("+-a[0]+","+-b[1]+")");d.g.selectAll("path.chord").attr("d",d.path).style("stroke",d.color)},drawTree:function(e){var d=this;if(e.children){for(var b=0;b<e.children.length;b+=1){var f=e.children[b];if(d.centroids[e.location]&&d.centroids[f.location]){var a=[d.centroids[e.location],d.centroids[f.location]];if(a[0]!==a[1]){d.g.append("path").attr("class","chord").datum({coordinates:a,type:"LineString"})}}else{console.log("didn't find location on map: "+f.location+" or "+e.location)}d.drawTree(f)}}}})})();